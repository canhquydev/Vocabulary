<!DOCTYPE html>
<html>
<head>
  <title>Trang ch√≠nh</title>
  <style>
    /* CSS kh√¥ng ƒë·ªïi, gi·ªØ nguy√™n nh∆∞ c≈© */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: #333;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      background-color: #ffffff;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 100%;
      max-width: 1000px;
      box-sizing: border-box;
    }
    h2 {
      color: #007bff;
      margin-bottom: 20px;
      font-size: 2em;
      font-weight: 600;
    }
    h3 {
      color: #555;
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1.5em;
    }
    #question-counter {
        font-size: 1.1em;
        color: #6c757d;
        margin-bottom: 15px;
        font-weight: 500;
    }
    #sentence-display {
      background-color: #e9f2ff;
      border: 1px dashed #a0c4ff;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      font-size: 1.2em;
      line-height: 1.6;
      color: #333;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    form {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    input[type="text"] {
      flex-grow: 1;
      max-width: 300px;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
      outline: none;
    }
    button {
      padding: 12px 25px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease;
      min-width: 120px; /* Ensure buttons have a minimum width */
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    #review-button {
        background-color: #28a745; /* Green color for review */
    }
    #review-button:hover:not(:disabled) {
        background-color: #218838;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
      transform: translateY(-2px);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .message-success {
      color: #28a745;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .message-danger {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .message-info {
      color: red;
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .loading-spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    a {
      color: #007bff;
      text-decoration: none;
      margin-top: 20px;
      padding: 10px 20px;
      border: 1px solid #007bff;
      border-radius: 5px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    a:hover {
      background-color: #007bff;
      color: white;
    }
    .controls-section {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .controls-section a {
      background-color: #17a2b8;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      transition: background-color 0.3s;
    }
    .controls-section a:hover {
      background-color: #138496;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ch√†o m·ª´ng {{ username }}!</h2>

    <h3>C√¢u h·ªèi:</h3>
    <p id="question-counter">{{ question_info }}</p>
    <p id="sentence-display">{{ sentence }}</p>

    <form autocomplete="off" id="answer-form">
      <input type="text" style="display:none">
      <input type="hidden" name="correct_word" id="correct-word-input" value="{{ correct_word }}">
      <input type="text" name="answer" id="user-answer-input" placeholder="Nh·∫≠p t·ª´ b·ªã ·∫©n" autocomplete="off">
      <button type="submit" id="check-button">Ki·ªÉm tra</button>
    </form>

    <div class="button-group">
      <button id="skip-button">B·ªè qua</button>
      <button id="regenerate-button">T·∫°o l·∫°i c√¢u</button>
      <button id="review-button">√în t·∫≠p l·∫°i</button>
    </div>

    <p id="feedback-message"></p>
    <p id="skip-reveal-message"></p>
    
    <div class="controls-section">
        <a href="{{ url_for('manage_vocabulary') }}">Qu·∫£n l√Ω t·ª´ v·ª±ng</a>
        {% if roles == 'admin' %}
        <a href="{{ url_for('manage_accounts') }}" style="background-color: #ffc107; color: #212529;">Qu·∫£n l√Ω t√†i kho·∫£n</a>
        {% endif %}
    </div>
    <br>
    <a href="/logout" id="logout-link" style="background-color: #6c757d; border-color: #6c757d;">ƒêƒÉng xu·∫•t</a>
  </div>

  <script>
    // Javascript kh√¥ng ƒë·ªïi, gi·ªØ nguy√™n nh∆∞ c≈©
    document.addEventListener('DOMContentLoaded', function() {
        const answerForm = document.getElementById('answer-form');
        const userAnswerInput = document.getElementById('user-answer-input');
        const correctWordInput = document.getElementById('correct-word-input');
        const sentenceDisplay = document.getElementById('sentence-display');
        const feedbackMessage = document.getElementById('feedback-message');
        const skipRevealMessage = document.getElementById('skip-reveal-message');
        const questionCounter = document.getElementById('question-counter');

        const skipButton = document.getElementById('skip-button');
        const regenerateButton = document.getElementById('regenerate-button');
        const reviewButton = document.getElementById('review-button');
        const checkButton = document.getElementById('check-button');
        const allButtons = [skipButton, regenerateButton, reviewButton, checkButton];

        function showLoading(button, text) {
            button.disabled = true;
            button.innerHTML = `<span class="loading-spinner"></span> ${text}...`;
        }

        function hideLoading(button, originalText) {
            button.disabled = false;
            button.innerHTML = originalText;
        }

        function setButtonsState(disabled) {
            allButtons.forEach(btn => btn.disabled = disabled);
            userAnswerInput.disabled = disabled;
        }

        function updateUI(data) {
            if (data.completed) {
                const message = "üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u h·ªèi. B·∫•m '√în t·∫≠p l·∫°i' ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.";
                sentenceDisplay.textContent = message;
                questionCounter.textContent = "Ho√†n th√†nh!";
                setButtonsState(true); 
                reviewButton.disabled = false;
                userAnswerInput.value = '';
                correctWordInput.value = '';
            } else {
                sentenceDisplay.textContent = data.sentence;
                correctWordInput.value = data.correct_word;
                questionCounter.textContent = `C√¢u ${data.question_number}/${data.total_questions}`;
                userAnswerInput.value = '';
                feedbackMessage.textContent = '';
                skipRevealMessage.textContent = '';
                setButtonsState(false);
            }
        }

        async function fetchNextWord() {
            showLoading(skipButton, 'ƒêang t·∫£i');
            try {
                const response = await fetch('/next_word', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Error fetching next word:', error);
                feedbackMessage.textContent = 'L·ªói khi t·∫£i t·ª´ m·ªõi.';
            } finally {
                hideLoading(skipButton, 'B·ªè qua');
            }
        }

        answerForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            showLoading(checkButton, 'Ki·ªÉm tra');
            const userAnswer = userAnswerInput.value;
            const correctWord = correctWordInput.value;
            try {
                const response = await fetch('/check_answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer: userAnswer, correct_word: correctWord })
                });
                const data = await response.json();
                if (data.success) {
                    feedbackMessage.textContent = `‚úÖ Ch√≠nh x√°c! ${data.word} - ${data.meaning}`;
                    feedbackMessage.className = 'message-success';
                    setButtonsState(true);
                    setTimeout(() => { fetchNextWord(); }, 1500);
                } else {
                    feedbackMessage.textContent = data.message;
                    feedbackMessage.className = 'message-danger';
                }
            } catch (error) {
                console.error('Error checking answer:', error);
                feedbackMessage.textContent = 'L·ªói khi ki·ªÉm tra ƒë√°p √°n.';
            } finally {
                hideLoading(checkButton, 'Ki·ªÉm tra');
            }
        });

        skipButton.addEventListener('click', async function() {
            const currentWord = correctWordInput.value;
            if(currentWord) {
                skipRevealMessage.textContent = `ƒê√°p √°n l√†: ${currentWord}`;
                skipRevealMessage.className = 'message-info';
            }
            await fetchNextWord();
        });

        regenerateButton.addEventListener('click', async function() {
            showLoading(regenerateButton, 'ƒêang t·∫°o');
            const currentWord = correctWordInput.value;
            try {
                const response = await fetch('/regenerate_sentence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ word: currentWord })
                });
                const data = await response.json();
                if (data.success) {
                    sentenceDisplay.textContent = data.new_sentence;
                } else {
                    feedbackMessage.textContent = data.message;
                    feedbackMessage.className = 'message-danger';
                }
            } catch (error) {
                console.error('Error regenerating sentence:', error);
                feedbackMessage.textContent = 'L·ªói khi t·∫°o l·∫°i c√¢u.';
            } finally {
                hideLoading(regenerateButton, 'T·∫°o l·∫°i c√¢u');
            }
        });

        reviewButton.addEventListener('click', async function() {
            showLoading(reviewButton, 'B·∫Øt ƒë·∫ßu');
            try {
                const response = await fetch('/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Error starting review:', error);
                feedbackMessage.textContent = 'L·ªói khi b·∫Øt ƒë·∫ßu √¥n t·∫≠p.';
            } finally {
                hideLoading(reviewButton, '√în t·∫≠p l·∫°i');
            }
        });
    });
  </script>
</body>
</html>